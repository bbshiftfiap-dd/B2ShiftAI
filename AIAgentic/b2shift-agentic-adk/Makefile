# Makefile para B2Shift Customer Clustering Agent
# Facilita execuÃ§Ã£o de comandos comuns de desenvolvimento e deploy

.PHONY: help install setup test demo deploy clean docs

# VariÃ¡veis
PYTHON := python
POETRY := poetry
PROJECT_NAME := b2shift-cluster-agent

# Help
help: ## Mostra este menu de ajuda
	@echo "ğŸ¤– B2Shift Customer Clustering Agent - Comandos DisponÃ­veis"
	@echo "================================================================"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""

# InstalaÃ§Ã£o e Setup
install: ## Instala dependÃªncias usando Poetry
	@echo "ğŸ“¦ Instalando dependÃªncias..."
	$(POETRY) install
	@echo "âœ… DependÃªncias instaladas!"

setup: install ## Executa setup completo do projeto
	@echo "ğŸ”§ Executando setup do projeto..."
	$(PYTHON) setup.py
	@echo "âœ… Setup concluÃ­do!"

# Testes
test: ## Executa todos os testes
	@echo "ğŸ§ª Executando testes..."
	$(POETRY) run pytest tests/ -v
	@echo "âœ… Testes concluÃ­dos!"

test-agent: ## Testa apenas o agente principal
	@echo "ğŸ¤– Testando agente principal..."
	$(POETRY) run pytest tests/test_b2shift_agent.py -v

test-clustering: ## Testa algoritmos de clusterizaÃ§Ã£o
	@echo "ğŸ“Š Testando algoritmos de clusterizaÃ§Ã£o..."
	$(POETRY) run pytest tests/ -k "cluster" -v

# DemonstraÃ§Ãµes
demo: ## Executa demonstraÃ§Ã£o completa
	@echo "ğŸ¬ Executando demonstraÃ§Ã£o completa..."
	$(PYTHON) demo.py

demo-quick: ## Executa demonstraÃ§Ã£o rÃ¡pida
	@echo "âš¡ Executando demonstraÃ§Ã£o rÃ¡pida..."
	$(PYTHON) demo.py --quick

example-basic: ## Executa exemplo bÃ¡sico
	@echo "ğŸ“– Executando exemplo bÃ¡sico..."
	$(PYTHON) examples/basic_analysis.py

# ExecuÃ§Ã£o do Agent
run: ## Executa o agent via ADK CLI
	@echo "ğŸš€ Executando B2Shift Agent..."
	$(POETRY) run adk run b2shift_cluster

run-web: ## Executa interface web do ADK
	@echo "ğŸŒ Iniciando interface web..."
	$(POETRY) run adk web

run-cli: ## Executa agent via CLI customizado
	@echo "ğŸ’» Executando CLI customizado..."
	$(POETRY) run b2shift-agent

# Deploy e Cloud
deploy-create: ## Faz deploy no Vertex AI Agent Engine
	@echo "â˜ï¸ Fazendo deploy no Vertex AI..."
	$(PYTHON) deployment/deploy.py --action create

deploy-test: ## Testa deployment (requer RESOURCE_ID)
	@echo "ğŸ§ª Testando deployment..."
	@if [ -z "$(RESOURCE_ID)" ]; then \
		echo "âŒ Erro: RESOURCE_ID Ã© obrigatÃ³rio"; \
		echo "Uso: make deploy-test RESOURCE_ID=seu_resource_id"; \
		exit 1; \
	fi
	$(PYTHON) deployment/test_deployment.py --resource-id $(RESOURCE_ID)

deploy-delete: ## Remove deployment (requer RESOURCE_ID)
	@echo "ğŸ—‘ï¸ Removendo deployment..."
	@if [ -z "$(RESOURCE_ID)" ]; then \
		echo "âŒ Erro: RESOURCE_ID Ã© obrigatÃ³rio"; \
		echo "Uso: make deploy-delete RESOURCE_ID=seu_resource_id"; \
		exit 1; \
	fi
	$(PYTHON) deployment/deploy.py --action delete --resource-id $(RESOURCE_ID)

# Build e Package
build: ## ConstrÃ³i wheel package
	@echo "ğŸ”¨ Construindo package..."
	$(POETRY) build --format=wheel --output=dist/
	@echo "âœ… Package construÃ­do em dist/"

build-docker: ## ConstrÃ³i imagem Docker (se Dockerfile existir)
	@if [ -f Dockerfile ]; then \
		echo "ğŸ³ Construindo imagem Docker..."; \
		docker build -t $(PROJECT_NAME) .; \
	else \
		echo "âš ï¸ Dockerfile nÃ£o encontrado"; \
	fi

# Linting e FormataÃ§Ã£o
lint: ## Executa linting com flake8
	@echo "ğŸ” Executando linting..."
	$(POETRY) run flake8 b2shift_cluster/ tests/ examples/

format: ## Formata cÃ³digo com black
	@echo "âœ¨ Formatando cÃ³digo..."
	$(POETRY) run black b2shift_cluster/ tests/ examples/

format-check: ## Verifica formataÃ§Ã£o sem alterar
	@echo "ğŸ‘€ Verificando formataÃ§Ã£o..."
	$(POETRY) run black --check b2shift_cluster/ tests/ examples/

# DocumentaÃ§Ã£o
docs: ## Gera documentaÃ§Ã£o
	@echo "ğŸ“š Gerando documentaÃ§Ã£o..."
	@echo "DocumentaÃ§Ã£o disponÃ­vel em docs/"
	@ls -la docs/

docs-serve: ## Serve documentaÃ§Ã£o localmente (se MkDocs estiver configurado)
	@if command -v mkdocs >/dev/null 2>&1; then \
		echo "ğŸ“– Servindo documentaÃ§Ã£o..."; \
		mkdocs serve; \
	else \
		echo "ğŸ“š DocumentaÃ§Ã£o em docs/"; \
		echo "ğŸ“„ README: README.md"; \
		echo "ğŸ¢ Contexto B2Shift: docs/b2shift_context.md"; \
		echo "ğŸ§® Algoritmos: docs/algorithms.md"; \
	fi

# Dados e Samples
data-generate: ## Gera dados de exemplo
	@echo "ğŸ“Š Gerando dados de exemplo..."
	$(PYTHON) -c "from setup import B2ShiftSetup; B2ShiftSetup().create_sample_data()"

data-clean: ## Remove dados gerados
	@echo "ğŸ§¹ Limpando dados gerados..."
	rm -rf data/sample/*.csv data/sample/*.json

# Ambiente e ConfiguraÃ§Ã£o
env-check: ## Verifica configuraÃ§Ã£o do ambiente
	@echo "ğŸ” Verificando ambiente..."
	@echo "Python: $$($(PYTHON) --version)"
	@echo "Poetry: $$($(POETRY) --version)"
	@if [ -f .env ]; then \
		echo "âœ… Arquivo .env existe"; \
	else \
		echo "âš ï¸ Arquivo .env nÃ£o encontrado - execute 'make setup'"; \
	fi

env-template: ## Cria template .env a partir do exemplo
	@if [ ! -f .env ] && [ -f .env.example ]; then \
		echo "ğŸ“ Criando .env a partir do template..."; \
		cp .env.example .env; \
		echo "âœ… Arquivo .env criado - edite com suas configuraÃ§Ãµes"; \
	else \
		echo "â„¹ï¸ Arquivo .env jÃ¡ existe ou template nÃ£o encontrado"; \
	fi

# Limpeza
clean: ## Remove arquivos temporÃ¡rios e cache
	@echo "ğŸ§¹ Limpando arquivos temporÃ¡rios..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete 2>/dev/null || true
	find . -type f -name "*.pyo" -delete 2>/dev/null || true
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	rm -rf .pytest_cache/ 2>/dev/null || true
	rm -rf dist/ 2>/dev/null || true
	rm -rf build/ 2>/dev/null || true
	@echo "âœ… Limpeza concluÃ­da!"

clean-all: clean data-clean ## Remove tudo (cache, dados, builds)
	@echo "ğŸ§¹ Limpeza completa realizada!"

# Status e Info
status: ## Mostra status do projeto
	@echo "ğŸ“Š B2Shift Customer Clustering Agent - Status"
	@echo "=============================================="
	@echo "ğŸ“ Projeto: $(PROJECT_NAME)"
	@echo "ğŸ Python: $$($(PYTHON) --version)"
	@echo "ğŸ“¦ Poetry: $$($(POETRY) --version)"
	@echo ""
	@echo "ğŸ“‚ Estrutura do Projeto:"
	@find . -maxdepth 2 -type d -name "b2shift_cluster*" -o -name "tests" -o -name "docs" -o -name "examples" -o -name "deployment" | head -10
	@echo ""
	@echo "ğŸ§ª Ãšltimos Testes:"
	@if [ -f .pytest_cache/README.md ]; then \
		echo "âœ… Cache de testes encontrado"; \
	else \
		echo "âš ï¸ Nenhum teste executado ainda"; \
	fi
	@echo ""
	@echo "âš™ï¸ ConfiguraÃ§Ã£o:"
	@if [ -f .env ]; then \
		echo "âœ… Arquivo .env configurado"; \
	else \
		echo "âŒ Arquivo .env nÃ£o encontrado"; \
	fi

info: status ## Alias para status

# Comandos de desenvolvimento
dev-install: ## Instala dependÃªncias de desenvolvimento
	@echo "ğŸ‘¨â€ğŸ’» Instalando dependÃªncias de desenvolvimento..."
	$(POETRY) install --with dev

dev-shell: ## Ativa shell do Poetry
	@echo "ğŸš Ativando shell do Poetry..."
	$(POETRY) shell

# Quick Start
quickstart: install setup demo-quick ## Setup rÃ¡pido + demo
	@echo "ğŸš€ Quick start concluÃ­do!"
	@echo ""
	@echo "ğŸ‰ B2Shift Agent estÃ¡ pronto para uso!"
	@echo ""
	@echo "ğŸ“‹ PrÃ³ximos comandos Ãºteis:"
	@echo "  make run          # Executa o agent"
	@echo "  make run-web      # Interface web"
	@echo "  make demo         # Demo completa"
	@echo "  make test         # Executar testes"
	@echo "  make help         # Ver todos os comandos"

# Default target
.DEFAULT_GOAL := help
